\documentclass[12pt]{report}
\usepackage[a4paper,margin=1in]{geometry}
\usepackage{setspace} % for single/doublespacing commands
\usepackage{graphicx} % including graphics
\usepackage{sectsty} % sexy section headings
\usepackage{pdfpages} % including multipage pdfs
\usepackage[export]{adjustbox} % for graphic frames and center
\usepackage{amssymb} % special math symbols
\usepackage{cancel} % arrow and cross math cancel symbol
\usepackage[numbered]{matlab-prettifier} % including matlab w/ syntax highlighting
\usepackage[T1]{fontenc} % prettier matlab font
\usepackage[utf8]{inputenc}
\usepackage{circuitikz} % drawing fancy shit
\usepackage{xfrac} % more legible inline fractions (\sfrac)
\usepackage{lmodern} % font package for above
\usepackage{multicol} % multiple columns
\usepackage[justification=centering]{caption} % figure captions (force centering)
\usepackage{amsmath} % more math symbols and shit
\usepackage{enumitem} % add arguments for enumerate to change style
\usepackage[list=true]{subcaption} % subfigures with list of figure support
\usepackage{BOONDOX-cal} % fancy mathtype script
\usepackage[hidelinks]{hyperref} % clickable table of contents
\hypersetup{
    colorlinks=false, %set true if you want colored links
    linktoc=all,     %set to all if you want both sections and subsections linked
}

\newcommand{\eqname}[1]{\tag*{#1}}% Tag equation with name

\lstMakeShortInline[style=Matlab-editor]| % matlab inline escape character
\usetikzlibrary{arrows,calc,patterns,angles,quotes}
\usetikzlibrary{decorations.pathmorphing,decorations.pathreplacing} % for snakes!
\graphicspath{{images/}}

\allsectionsfont{\centering}
\renewcommand\thesection{\arabic{section}}
\renewcommand{\thefootnote}{\arabic{footnote}}
\setcounter{tocdepth}{2}

\newcommand{\Lag}{\mathcal{L}} % lagrangian L

\begin{document}

\input{titlepage}
\pagenumbering{roman}
{\tableofcontents\let\clearpage\relax\listoffigures}
\clearpage
\pagenumbering{arabic}
\newpage
\begin{flushleft}

% ---------------------------------------------------------------------------- %
\section{Conceptualize the Problem}
% ---------------------------------------------------------------------------- %
\begin{figure}[h]
  \begin{minipage}[c]{.4\textwidth}
  \input{concept}
\end{minipage}%
\begin{minipage}[c]{.6\textwidth}
  The pendulum system consists of a rigid bar pinned to the free end of a linear spring,
  which rotates about its opposite end at a fixed point; there are three degrees of freedom,
  since the spring and bar each have an individual angular deflection with respect to the vertical,
  and the radial distance the bar is from the point of rotation due to the variation in the
  length of the spring.
\end{minipage}
\end{figure}

\subsection{Constants and Assumptions}
\begin{tabular}{ll@{\hskip .75in}l}
 \multicolumn{1}{c}{Constants:} && \multicolumn{1}{c}{Assumptions:} \\
 Bar Mass: &$m_b$ = 1 kg & No Losses\\
 Bar Length: &$\ell_b$ = 1 m & Released from Rest\\
 Gravity: &$g$ = 9.81 $\sfrac{\text{m}}{\text{s$^2$}}$ &Uniform Slender Bar \\
 Linear Spring: &&Planar\\
 \quad Spring Coefficient:& $k = 25~\sfrac{\text{N}}{\text{m}}$ &Rigid-Body Dynamics \\
 \quad Unstretched Length:& $\ell_0$ = 0.5 m \\
\end{tabular}
\vspace{5ex}

We are asked to determine the following: \\
\begin{enumerate}
  \item The Equations of Motion for the system via the Lagrangian method.
  \item Integrate the Equations of Motion using various initial conditions and plot
  the behavior of the system for 10 seconds. \\
  \vspace{2ex}
  $
  \begin{array}{cll}
    \text{(a)} & \theta_o = 0~rad, & \phi_o = 0~rad \\
    \text{(b)} & \theta_o = \sfrac{\pi}{18}~rad, & \phi_o = \sfrac{\pi}{9}~rad \\
    \text{(c)} & \theta_o = \sfrac{\pi}{6}~rad, & \phi_o = \sfrac{\pi}{3}~rad \\
  \end{array}
  $
  \item Plot the total energy versus time for all 3 cases.
  \item Repeat 2. and 3. using a '|RelTol|' of 1e-6 and '|AbsTol|' of 1e-9 for the
  |ode45| integration tolerances.
\end{enumerate}
\newpage
% ---------------------------------------------------------------------------- %
\section{Free Body Diagram}
% ---------------------------------------------------------------------------- %
\begin{figure}[!htp]
  \caption{Acceleration and Free Body Diagrams}
   \begin{minipage}[c]{.5\textwidth}
     \begin{subfigure}{\textwidth}
       \center
      \input{fbd} \\
      \vspace{2ex}
      \caption{Free Body Diagram}
      \label{fbd}
      \end{subfigure}
   \end{minipage}%
   \begin{minipage}[c]{.5\textwidth}
     \begin{subfigure}{\textwidth}
       \center
       \input{ad} \\
       \vspace{3ex}
       \caption{Acceleration Diagram}
       \label{ad}
    \end{subfigure}
   \end{minipage}
\end{figure}
  \center
  \begin{tabular}{rl@{\hskip .5in}rl}
  $G$:&Center of gravity of the bar &$\vec{v}_G$:& Velocity of bar center of gravity\\
  $\ell_0$:& Spring unstretched length  &$\ddot{\theta}$:& Angular velocity of spring \\
  $\delta$:& Spring deflection &$\ddot{\phi}$:& Angular velocity of bar\\
  $k$:& Spring constant &$\ddot{\ell}_s$:& Radial acceleration of spring \\
  $h_{b}$:& Height of bar from datum \\
  $F_s$:& Force onto bar due to spring\\
  $A_{\theta}$:& Pin reaction in $\theta$ direction\\
  $A_{t}$:& Pin reaction in tangential direction \\
\end{tabular}

% ---------------------------------------------------------------------------- %
\section{Coordinate Frame} \label{section:coord}
% ---------------------------------------------------------------------------- %
\begin{figure}[!htp]
    \begin{minipage}[c]{.4\textwidth}
      \center
      \input{coord}
      \caption{Coordinate Frame}
      \label{coord}
      \vspace{2ex}
    \end{minipage}%
    \begin{minipage}[c]{.6\textwidth}
      \center
      \begin{tabular}{rl}
      & \quad Motion Variables: \\
      $\theta$:& Angle of spring relative to vertical\\
      $\phi$:& Angle of bar relative to vertical\\
      $\ell_s$:& Radial length of spring \\
      \\
      & \quad Supplemental Variables: \\
      $\vec{r}_G$:& Vector to bar center of mass from origin \\
    \end{tabular}
    \end{minipage}
\end{figure}
% ---------------------------------------------------------------------------- %
\section{Sum of Forces}
% ---------------------------------------------------------------------------- %
From Figure (\ref{coord}),
$$\vec{r}_G = \left[\ell_s\sin(\theta) + \frac{\ell_b}{2}\sin(\phi)\right]\hat{\textrm{\i}}
 + \left[-\ell_s\cos(\theta) - \frac{\ell_b}{2}\cos(\phi)\right]\hat{\textrm{\j}}$$

Taking the time derivative,
$$\frac{d}{dt}\vec{r}_G = \dot{\vec{r}}_G = \vec{v}_G$$
$$
\vec{v}_G =
\left[\dot{\ell}_s\sin(\theta) + \frac{\ell_b\dot{\phi}\cos(\phi)}{2} +
\ell_s\dot{\theta}\cos(\theta)\right]\hat{\textrm{\i}} +
\left[\frac{\ell_b\dot{\phi}\sin(\phi)}{2} -
\dot{\ell}_s\cos(\theta) + \ell_s\dot{\theta}\sin(\theta)\right]\hat{\textrm{\j}}
$$

Kinetic Energy of Spring:
$$T_1 = 0$$
Kinetic Energy of Bar, due to it's rotational and translational velocity (Figure \ref{ad}):
$$T_2 = \frac{1}{2}m_{b}(\vec{v}_G \cdot \vec{v}_G) + \frac{1}{2}I\omega^2$$
Since the moment of inertia $I$ for a uniform slender bar rotating about its end is
$\dfrac{1}{12}m\ell^2$ and $\omega = \dot{\phi}$,
$$T_2 = \frac{1}{2}m_{b}(\vec{v}_G \cdot \vec{v}_G) + \frac{1}{24}m_{b}\ell_b^2\dot{\phi}^2$$
Total Kinetic Energy:
\begin{equation}
T = T_1 + T_2 = \frac{1}{2}m_{b}(\vec{v}_G \cdot \vec{v}_G) + \frac{1}{24}m_{b}\ell_b^2\dot{\phi}^2
\end{equation}

Potential Energy of Spring due to it's stretch (Figure \ref{fbd}):
$$V_1 = \frac{1}{2}k\big(\ell_s-\ell_0\big)^2$$
Potential Energy of Bar, due to it's distance below the datum, $h_{bar}$ (Figure \ref{fbd}):
$$V_2 = - m_bg\big(\ell_s\cos(\theta) + \frac{\ell_b}{2}\cos(\phi)\big)$$
Total Potential Energy:
\begin{equation}
V = V_1 + V_2 = \frac{1}{2}k\big(\ell_s-\ell_0\big)^2 - m_bg\big(\ell_s\cos(\theta) + \frac{\ell_b}{2}\cos(\phi)\big)
\end{equation}
\newpage
% ---------------------------------------------------------------------------- %
\section{Knowns and Unknowns} \label{knownsandunknowns}
% ---------------------------------------------------------------------------- %
\begin{tabular}{ll@{\hskip .75in}ll}
  \multicolumn{1}{c}{Knowns:} && \multicolumn{1}{c}{Unknowns:} \\
  Bar Mass: &$m_b$ = 0.25 kg & Accelerations: & $\ddot{\theta},~\ddot{\phi},~\ddot{\ell}_s$ \\
  Bar Length: &$\ell_b$ = 1 m & \\
  Gravity: &$g$ = 9.81 $\sfrac{\text{m}}{\text{s$^2$}}$& \\
  Linear Spring: \\
  \quad Spring Coefficient:& $k = 25~\sfrac{\text{N}}{\text{m}}$\\
  \quad Unstretched Length:& $\ell_0$ = 0.5 m \\
  State Variables: \\
  \quad Angular \& Radial Position: &$\theta,~\phi,\ell_s$ \\
  \quad Angular \& Radial Velocity: &$\dot{\theta},~\dot{\phi},~\dot{\ell}_s$ & \\
\end{tabular}
\vspace{2ex}

Since there are six equations and six unknowns, we can solve for the equations of
motion analytically using Matlab.

% ---------------------------------------------------------------------------- %
\section{Constraints}
% ---------------------------------------------------------------------------- %
The system is fully constrained, therefore no constraint equations were needed to
solve the problem.
% ---------------------------------------------------------------------------- %
\section{Solve for the Equations of Motion}
% ---------------------------------------------------------------------------- %
The Lagrangian $\Lag \equiv T - V$.
The equations of motion are a linear combination of the time derivative of the partial derivative of the Lagrangian with respect to the first derivative of the motion variable with
respect to time, minus the partial derivative of the Lagrangian with respect to the variable
 of motion. These equations are set equal to the non-conservative forces in the system,
 $(Q_j)_{\text{non}}$ which in this particular case there are none, since there are no
 non-conservative forces acting (such as drag, applied forces, etc).

\begin{minipage}[b]{.5\textwidth}
\begin{equation}
\ddot{\theta} = \frac{d}{dt}\left(\frac{\partial\Lag}{\partial\dot{\theta}}\right) -
\frac{\partial\Lag}{\partial\theta} = \big(Q_{\theta}\big)_{\text{non}}
\label{eq:lagtheta}
\end{equation}
\end{minipage}%
\begin{minipage}[b]{.5\textwidth}
\begin{equation}
\ddot{\phi} = \frac{d}{dt}\left(\frac{\partial\Lag}{\partial\dot{\phi}}\right) -
\frac{\partial\Lag}{\partial\phi} = \big(Q_{\phi}\big)_{\text{non}}
\label{eq:lagphi}
\end{equation}
\end{minipage}
\begin{equation}
\ddot{\ell}_s = \frac{d}{dt}\left(\frac{\partial\Lag}{\partial\dot{\ell}_s}\right) -
\frac{\partial\Lag}{\partial\ell_s} = \big(Q_{\ell_s}\big)_{\text{non}}
\label{eq:lagspring}
\end{equation}

\begin{equation}
\begin{split}
\Lag =
\frac{m_b}{2}\left[
\left(\dot{\ell}_s\sin(\theta) + \frac{\ell_b\dot{\phi}\cos(\phi)}{2} + \ell_s\dot{\theta}\cos(\theta)\right)^2 +
\left(\frac{\ell_b\dot{\phi}\sin(\phi)}{2} - \dot{\ell}_s\cos(\theta) + \ell_s\dot{\theta}\sin(\theta)\right)^2 \right] \\
- \frac{k(\ell_0 - \ell_s)^2}{2} + \frac{\ell_b^2m_b\dot{\phi}^2}{24} +
gm_b\left(\frac{\ell_b\cos(\phi)}{2} + \ell_s\cos(\theta)\right)
\label{eq:lag}
\end{split}
\end{equation}


Using Equations (\ref{eq:lagtheta}), (\ref{eq:lagphi}), (\ref{eq:lagspring}) and (\ref{eq:lag}), we can
solve for the three Equations of Motion with Matlab.

\begin{lstlisting}[frame=lines,style=Matlab-editor,basicstyle = \mlttfamily]
Lagrangian = T - V;

% Partial of Lagrange Eq. w.r.t. thetadot
dLdthetadot = diff(Lagrangian,thetadot);
dLdthetadot_subbed = subs(dLdthetadot, [thetat, thetadot, phit, phidot, l1t, l1dot],...
    [theta, diff(theta,t), phi, diff(phi,t), l1, diff(l1,t)]);
% Time derivative of Partial of Lagrange Eq. w.r.t. thetadot
ddLdthetadotdt = diff(dLdthetadot_subbed,t);
% Partial of Lagrange Eq. w.r.t. theta
dLdtheta = diff(Lagrangian,thetat);

% Theta EOM
eqn(1) = ddLdthetadotdt - dLdtheta == 0;
\end{lstlisting}
Similarly, the other Equations of Motion can be found in the Appendix -- Numerical Solution.



\newpage
% ---------------------------------------------------------------------------- %
\section{Solve the Equations of Motion}
% ---------------------------------------------------------------------------- %
\begin{figure}[!htp]
  \caption{Numerical Solution Motion Behavior Plot, ($\theta_o:~0,~\phi_o:~0$)}
  \begin{subfigure}[t]{\textwidth}
  \includegraphics[center]{spring_0-0}
  \caption{Spring Length vs. Time}
  \label{fig:spring:0:0}
\end{subfigure}
\end{figure}

\begin{figure}[!htp] \ContinuedFloat
  \caption{Numerical Solution Motion Behavior Plots, ($\theta_o:\sfrac{\pi}{18},~\phi_o:\sfrac{\pi}{9}$)}
\begin{subfigure}[t]{\textwidth}
  \includegraphics[center]{spring_18-9}
  \caption{Spring Length vs. Time}
  \label{fig:spring:18-9}
\end{subfigure}
\end{figure}

\begin{figure}[!htp] \ContinuedFloat
  \phantomcaption
\begin{subfigure}[t]{\textwidth}
  \includegraphics[center]{angles_18-9}
  \caption{Angular Position vs. Time}
  \label{fig:angles:18-9}
\end{subfigure}
\end{figure}

\begin{figure}[!htp] \ContinuedFloat
  \caption{Numerical Solution Motion Behavior Plots, ($\theta_o:\sfrac{\pi}{6},~\phi_o:\sfrac{\pi}{3}$)}
\begin{subfigure}[t]{\textwidth}
  \includegraphics[center]{spring_6-3}
  \caption{Spring Length vs. Time}
  \label{fig:spring:6-3}
\end{subfigure}
\end{figure}

\begin{figure}[!htp] \ContinuedFloat
  \phantomcaption
\begin{subfigure}[t]{\textwidth}
  \includegraphics[center]{angles_6-3}
  \caption{Angular Position vs. Time}
  \label{fig:angles:6-3}
\end{subfigure}
\end{figure}

% ---------------------------------------------------------------------------- %
\section{Does it Make Sense?}
% ---------------------------------------------------------------------------- %
\subsection{Units}
Checking with the MATLAB symbolic units tool (from Section \ref{appendix:numerical}): \\
~\\
% \input{unitcheck}
\subsection{Magnitude}

\section{Appendix} \label{appendix}
\subsection{Attributions}
\onehalfspacing
\begin{tabular}{ll}
Jeffrey Chen & \\
Thorne Wolfenbarger & \\
Trey Dufrene & \\
Joint Effort &
\end{tabular}
\singlespacing

\newpage
\subsection{Analytical Solution}

\newpage
\subsection{Numerical Solution} \label{appendix:numerical}
% \input{matlab}
% TODO: Add scan of Thorne's work?
\begin{figure}[!htp]
  \caption{Comparison Plots of ode45 Tolerance Options}
  \begin{subfigure}{\textwidth}
    \includegraphics[center]{1}
    \caption*{Spring Deflection, ($\theta_o:~0,~\phi_o:~0$)}
  \end{subfigure}
  \begin{subfigure}{\textwidth}
    \includegraphics[center]{2}
    \caption*{Spring Deflection, ($\theta_o:\sfrac{\pi}{18},~\phi_o:\sfrac{\pi}{9}$)}
  \end{subfigure}
  \begin{subfigure}{\textwidth}
    \includegraphics[center]{4}
    \caption*{Spring Deflection, ($\theta_o:\sfrac{\pi}{6},~\phi_o:\sfrac{\pi}{3}$)}
  \end{subfigure}
\end{figure}
\begin{figure}[!htp] \ContinuedFloat
  \begin{subfigure}{\textwidth}
    \includegraphics[center]{3}
    \caption*{Bar and Spring Angular Deflection, ($\theta_o:\sfrac{\pi}{18},~\phi_o:\sfrac{\pi}{9}$)}
  \end{subfigure}
  \begin{subfigure}{\textwidth}
    \includegraphics[center]{5}
    \caption*{Bar and Spring Angular Deflection, ($\theta_o:\sfrac{\pi}{6},~\phi_o:\sfrac{\pi}{3}$)}
  \end{subfigure}
\end{figure}

\end{flushleft}
\end{document}
